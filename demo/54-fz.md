статус документа: черновик

[![яндекс касса](/i/yakassalogo.png "Яндекс Касса")](https://kassa.yandex.ru) / документация / [http](/demo/010%20интеграция%20для%20самописных%20сайтов.md):arrow_left:, [cms](/demo/011%20интеграция%20для%20CMS%20и%20SaaS.md), [email](/010%20интеграция%20email.md), [тестирование](/demo/030%20тестирование.md), [решение ошибок](/demo/031%20решение%20ошибок.md), [демо](/demo/032%20демо%20стенд.md)

54-ФЗ. Нюансы интеграции и необходимые доработки
================================================

Эта статья для тех, кто использует свои собственные скрипты взаимодействия с Яндекс.Кассой.

### Требования
- [x] Зарегистрируйтесь в Атол или МодульКассе. Получите у них идентификаторы.
- [x] Впишите полученные идентификаторы в Личном Кабинете Яндекс.Кассы https://kassa.yandex.ru/blog/lk54fz
- [ ] Если у вас сайт на CMS, обновить [платежный модуль](https://kassa.yandex.ru/54fz#modules). Если самописный сайт, то дорабойте скрипты, чтобы из платежной формы передались нужные параметры в ym_merchant_receipt.

> Внимание! Как только вы пропишите идентификаторы фискализации в личном кабинете Яндекс.Кассы, практически сразу эти настройки попадут в нашу систему и после этого, если вы не будете передавать ym_merchant_receipt, платежи перестанут работать. Поэтому в Личном кабинете прописывайте эти настройки тогда, когда уверены, что все работает корректно.

### Доработать скрипт для передачи ym_merchant_receipt

Кроме всех параметров, что вы передавали раньше из платежной формы, теперь, при включении фискализации, нужно передавать состав корзины в параметре `ym_merchant_receipt`.

Пример1:
```html
<input name="ym_merchant_receipt"
  value='{"customerContact": "+79001231212",
        "taxSystem": 1,
          "items":[
            {"quantity": 1.154,"price": {"amount": 300.23},"tax": 3,"text": "Зеленый чай, кг."},
            {"quantity": 2,"price": {"amount": 200.00},"tax": 3,"text": "Кружка для чая, шт."}
                  ]}'
type="hidden"/>
<input name="sum" value="746.47" type="hidden">
```
Разъяснения к "Примеру1":
  * [Документация по всем параметрам и значениям](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-receipt-docpage/)
* Контакты для электронного чека
  * В `customerContact` указан номер телефона, поэтому электронный чек будет отправлен SMS сообщением на этот номер. Если передать электронный адрес, то электронный чек будет отправлен на него, например, `"customerContact": "inbox@usermail.tld"`.
  * Важно понимать, что   в `customerContact` можно передать только что-то одно, либо телефон, либо электронный адрес.
  * Не надо указать два адреса (и более), не надо указывать электронный адрес и телефон. И т.п. вариации. Иначе не будет никакой гарантии, что фискализация будет выполнена и покупатель получить электронный чек.
  * Корректность ввода телефонного номера и электронного адреса вам нужно контролировать на своей стороне. В случае, если они синтаксически указаны неверно, то плательщик не получит электронный чек.
  * На текущий момент гарантировано будут доставлены электронные чеки на мобильные номера +7 (Россия) и любой существующий электронный адрес. Возможность доставки на мобильные операторы других стран уточняйте у выбранного вами ОФД.
* Количество товаров, вес, цена
  * `quantity=1.154` - 1 кг 154 грамма Зеленого чая; `quantity=2` - 2 кружки для чая
  * `amount=300.23` - цена за 1 кг Зеленого чая; `amount=200.00` - цена за одну кружку
  * в составе `ym_merchant_receipt` не должно быть больше чем 100 позиций; можно, чтобы в одном чеке было 200 кружек чая, 150 кг. зеленого чая и т.д., но всего отдельных товаров в одном чеке не должно быть больше 100;  
  т.е. вот этих блоков:  
  `{"quantity": 1.154,"price": {"amount": 300.23},"tax": 3,"text": "Зеленый чай, кг."},`  
  должно быть не больше 100.
* Налоги
  * `taxSystem=1` - система налогообложения магазина общая СН
  * `tax=3` - НДС чека по ставке 10%
* Синтаксис
  * Обратите внимание, что параметры переданы в одинарных кавычках `value='JSON'` (так правильно). Ни в коем случае не передавайте значение `ym_merchant_receipt` в двойных кавычках, например, так `value="JSON"`, в этом случае в фискализацию все данные не попадут и платеж вообще может не пройти. Поэтому используйте одинарные кавычки при передаче `ym_merchant_receipt`.
* Сумма
  * Обратите внимание, что сумма платежа - это результатирующая сумма состава чека. В нашем случае это `(1 кг 154 грамма * 300.23 за кг) + (2 кружки * 200 руб. за кружку) = 746.47`. В партнера по фискализации (Атол, Модуль.Касса и т.д.) мы передаем `ym_merchant_receipt` и `sum` и они проверяют их соответствие, чтобы общая сумма чека из `ym_merchant_receipt` совпадала с суммой из `sum`. В результатирущей сумме из `ym_merchant_receipt` допустимы погрешности, округление, на уровне значений после запятой (десятые и сотые). В случае, если общая сумма `ym_merchant_receipt` не совпадет с значением из `sum`, платеж не будет фискализирован, платеж будет отменен нашей системой, плательщик получит свои средства обратно и вы на свою электронную почту получите письмо. См. пример письма об ошибке фискализации и прохождения платежа ниже.
* Описание товара
  * Описание одного товара передается в `text` и не должно превышать 64 символа. Не важно, кириллическое это наименование или наименование написанно литиницей.
<!--
* Учитывайте то, что все значение обрабатываются функцией URL Encode, а значит, например, если передать кириллическое значение, то один кириллический символ будет преобразован в 6 (буква "Ё" после обработки функцией URL Encode преобразиться в 6 символов "%D0%81").
-->
  
### Письмо о проблемах с платежом

```
от:   noreply@money.yandex.ru
тема: Транзакция не прошла. shopId 72491

Ваша онлайн-касса не отвечает. Мы не смогли отправить данные для чека и отменили операцию.
Номер транзакции 2000001201031
shopId 72491

Проверьте, что:
- онлайн-касса зарегистрирована в налоговой (на сайте nalog.ru),
- всё правильно указано в нашем личном кабинете (раздел "Настройки", блок "Онлайн-касса"),
- онлайн-касса подключена к интернету и сети.
Если вы арендуете онлайн-кассу, напишите в службу поддержки своего сервиса.

Подробнее о работе с онлайн-кассой: https://yandex.ru/support/checkout/payments/tax-sync.html

Если не удалось разобраться, в чем проблема — пишите на merchants@money.yandex.ru.
Команда Яндекс.Кассы
```

### FAQ

#### // CMS

**Q:** Мой сайт сделат на CMS. Какие модули уже поддерживают 54-ФЗ?

**A:** Актуальный список модулей здесь https://kassa.yandex.ru/54fz#modules

#### // Электронный чек

**Q:** Что будет, если покупатель не указал номер телефона и электронный адрес в `customerContact`?

**A:** Платеж не пройдет. Поэтому проверяйте на своей стороне условие, чтобы этот параметр был заполнен и заполнен корректно.


* Обзорная публикация по теме 54-ФЗ https://kassa.yandex.ru/54fz
* 
<!-- https://journal.tinkoff.ru/slozhno/online-kkt/ -->
