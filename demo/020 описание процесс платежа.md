> [интеграция для самописных сайтов](https://github.com/yandex-money/yandex-money-joinup/blob/master/demo/010%20интеграция%20для%20самописных%20сайтов.md), [интеграция для CMS или SaaS](https://github.com/yandex-money/yandex-money-joinup/blob/master/demo/011%20интеграция%20для%20CMS%20и%20SaaS.md)

Описание процесса платежа
=====================================================

Описание процесса платежа для схемы интеграции: самописные HTTPS-колбеки или при использовании готового платежного модуля в CMS или SaaS.

| Подробное описание шагов оплаты                       | Краткое описание        |
| ----------------------------------------------------- | ----------------------- |
| 1. Плательщик нажимает "оплатить" на вашем сайте.     | Сайт клиента, оплатить. |
| 2. Из вашей формы POST-запросом передаются [параметры](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-http-docpage/) и их значения на наш обработчик https://demomoney.yandex.ru/eshop.xml, одновременно происходит редирект плательщика на сайт Яндекс.Деньги. | POST; редирект на https://demomoney.yandex.ru/ |
| 3. Наша система проверяет полученные на eshop.xml параметры. | Проверка данных. |
| **3.1.** Если полученные параметры и их значения верные, плательщик видит [нашу страницу оплаты](https://demomoney.yandex.ru/eshop.xml?shopid=72491&scid=541855&sum=100.00&customerNumber=%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B8%D0%B7%20%D0%BE%D0%B1%D1%8F%D0%B7%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%B0%20customerNumber ), выбирает способ оплаты, вводит необходимые данные (номер карты и т.д.), нажимает "Оплатить". | Если ОК, то страница оплаты. | 
| **3.2.** Если в переданных на eshop.xml параметрах наша система обнаружит ошибку (неверное название параметра или значение), пользователь увидит нашу страницы ошибки. | Если ошибка, то страница ошибки. |
| 4. После того, как на этапе п.3.1 пользователь нажал "оплатить", мы обращаемся POST-запросом к вашему checkURL, чтобы проверить, есть ли такой заказ у вас. | POST на checkURL. |
| **4.1.** Если ваш скрипт checkURL отвечает кодом "0" ("да, такой заказ есть"), мы инициируем процесс списания с баланса плательщика (п.5). | `code="0"`, начинаем списание средств. | 
| **4.2.** Если скрипт checkURL отвечает любым другим кодом, ошибкой HTTP или просто ваш сайт не доступен по сети, мы показывает плательщику ошибку и платеж не проходит. | `code="1"`, показываем ошибку платежа. |
| 5. Наша система инициирует списание средств с баланса плательщика (если на этапе п.4.1. ваш checkURL ответил "0"). | |
| **5.1.** Если средств достаточно (карта рабочая и т.д.), мы холдируем (замораживаем) средства на балансе пользователя или если холд не возможен, списываем их. | Средств достаточно? Холдируем или списываем. |
| **5.2.** Если средств на балансе пользователя не достаточно (карта просрочена и т.д.), мы показываем эту информацию плательщику. Плательщик может вернуться на ваш сайт. Текущий платеж считается не успешным. Неуспешные платежи видны в Личном Кабинете Кассы как не оплаченные. | Средств не достаточно, иная ошибка? Показываем ошибку пользователю. |
| 6. Наша система отправляет POST-запрос на ваш avisoURL о том, что заказ оплачен (мы называем этот этап "доставка авизо"). | POST на avisoURL. |
| **6.1.** Если ваш avisoURL отвечает кодом "0", деньги списываются с баланса пользователя. | `code="0"`, зачисляем средства в магазин |
| **6.2.** Если ваш avisoURL отвечает любым другим кодом, ошибкой HTTP или просто не доступен по сети, мы выполняем еще 6 попыток доставки авизо (с равномерным интервалом, примерно в течении трех часов). Далее, при повторах доставки авизо, если ваш avisoURL ответит "0", то см. п. 6.1.; но если мы получаем любой ответ кроме "0", то продолжаем попытки доставки на ваш avisoURL. Если все 6 попыток не удачные, то холд суммы оплаты заказа снимается и пользователь может использовать средства по своему назначению, либо, если не было холда и мы списали средства, то происходит автоматический возврат средств на баланс пользователя. | `code="1"`, стучимся еще 6 раз; средства не зачисляются, если `code="1"`. |
| 7. Сумма всех успешных платежей будет перечислена на ваш расчетный счет на следующий банковский день. На электронную почту вы получаете реестры со списком оплаченных заказов за предыдущие сутки (реестр оплаченых платежей); письмо приходит примерно с 6 до 10 утра, время московское. | Деньги на р/с. Реестр на email. | 

### 54ФЗ

[Схема работы](https://kassa.yandex.ru/54fz#howitworks) (путь прохождения платежных данных для фискализации через Яндекс.Кассу) такая:  
    `Страница оплаты на вашем сайте -> Яндекс.Касса -> онлайн-касса (Атол или Модуль.Касса) -> ОФД (Платформа ОФД; ОФД.Я (Я=Ярус); Первый ОФД; OFD.ru; TaxCom)`.  
    Именно ОФД занимается доставкой электронного чека на email или мобильный телефон.

#### Пример при оплате картой

<!-- Действующие лица:
- Покупатель. Он же плательщик. Тот, кто оплачивает услуги на вашем сайте.
- Контрагент
--> 

1) Покупатель переходит на платежную форму на сайте контрагента. В платежной форме есть [параметры платежа](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-http-docpage/) и [параметры для чека](https://tech.yandex.ru/money/doc/payment-solution/payment-form/payment-form-receipt-docpage/). После нажатия кнопки "оплатить" происходит переход на платежную страницу на сайте https://money.yandex.ru/, при переходе мы (яндекс.деньги) автоматически проверяем корректность всех параметров, переданных из платежной формы, в том числе и orderNumber. Если все ок, покупатель видит форму для ввода карточных данных; если в параметрах есть ошибка, то вместо карточной формы покупатель видит сообщение "Техническая ошибка".

2) Покупатель вводит данные карты, нажимает "оплатить", проходит 3DS авторизацию операции и если она успешная Яндекс.Касса отправляет запрос checkOrder на checkURL вашего сайта. Если checkURL ответил успехом `code=0`, отправляем данные чека в онлайн кассу, если checkURL ответил ошибкой или не доступен, показываем кирпич.

3) Онлайн касса (Атол/Модуль Касса и т.д.) приняли данные чека и отдали в Яндекс.Кассу код успеха фискализации, далее мы идем в магазин с запросом paymentAviso и происходит клиринг по операции. Онлайн касса не ответила нам за 5 попыток отправки чека в течении 5 минут - отменяем операцию, шлем вам уведомление о недоступности онлайн кассы и отправляем в последнюю чек отмены (от греха подальше, ибо мы можем отвалиться по таймауту а в итоге онлайн касса обработает и отправит чек в ОФД).
